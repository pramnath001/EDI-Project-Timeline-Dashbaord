<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project History</title>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    h2 {
      color: #004080;
    }
    .filter-box {
      margin-bottom: 20px;
    }
    .filter-box select, .filter-box input {
      padding: 10px;
      margin-right: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #004080;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .view-btn {
      padding: 6px 12px;
      background: #004080;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Project History</h2>
  <div class="filter-box">
    <select id="filterType">
      <option value="customerName">Customer Name</option>
      <option value="channel">Communication Channel</option>
      <option value="ediDocs">EDI Document Types</option>
    </select>
    <input type="text" id="filterInput" placeholder="Enter filter value">
    <button onclick="applyFilter()">üîç Search</button>
	<button onclick="clearFilter()">‚ùå Clear Filter</button>
    <button onclick="exportCSV()">‚¨áÔ∏è Export</button>
  </div>
  <table id="historyTable">
    <thead>
      <tr>
        <th>Project Title</th>
        <th>Customer</th>
        <th>Channel</th>
        <th>EDI Docs</th>
        <th>Start Date</th>
        <th>Go-Live Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="historyBody">
      <!-- Rows will be populated dynamically -->
    </tbody>
  </table>

<script>
	  let projectData = [];
	  let originalData = [];
	  let currentPage = 1;
	  const rowsPerPage = 20;

	  async function fetchProjectHistory() {
		try {
		  const response = await fetch('https://script.google.com/macros/s/AKfycbynyVZcVRmC1RxwPiiYYIK8yPUWKNwV07gA6eZwDOQw0lHRBSPUKZ0_H7OYOFQXLnAl/exec');
		  const result = await response.json();
		  projectData = result;
		  originalData = [...projectData];
		  renderTable(projectData);
		} catch (error) {
		  alert("‚ùå Failed to load project history from Google Sheet.");
		  console.error(error);
		}
	  }

	  function renderTable(data) {
		const tbody = document.getElementById('historyBody');
		tbody.innerHTML = '';

		const start = (currentPage - 1) * rowsPerPage;
		const end = start + rowsPerPage;
		const paginatedData = data.slice(start, end);

		paginatedData.forEach((item, i) => {
		  const row = `
			<tr>
			  <td><a href="${item.sheetUrl || '#'}" target="_blank">${item.projectTitle}</a></td>
			  <td>${item.customerName}</td>
			  <td>${item.channel}</td>
			  <td>${item.ediDocs}</td>
			  <td>${item.startDate}</td>
			  <td>${item.goLiveDate}</td>
			  <td><button class="view-btn" onclick='viewDetails(${start + i})'>View</button></td>
			</tr>
		  `;
		  tbody.innerHTML += row;
		});

		renderPagination(data.length);
	  }

	  function renderPagination(totalItems) {
		const containerId = "paginationContainer";
		let pagination = document.getElementById(containerId);

		if (!pagination) {
		  pagination = document.createElement("div");
		  pagination.id = containerId;
		  pagination.style.marginTop = "20px";
		  pagination.style.textAlign = "center";
		  document.body.appendChild(pagination);
		}

		pagination.innerHTML = '';
		const totalPages = Math.ceil(totalItems / rowsPerPage);

		for (let i = 1; i <= totalPages; i++) {
		  const btn = document.createElement("button");
		  btn.textContent = i;
		  btn.style.margin = "0 5px";
		  btn.style.padding = "5px 10px";
		  btn.style.background = i === currentPage ? "#004080" : "#ccc";
		  btn.style.color = i === currentPage ? "#fff" : "#000";
		  btn.style.border = "none";
		  btn.style.borderRadius = "4px";
		  btn.style.cursor = "pointer";

		  btn.addEventListener("click", () => {
			currentPage = i;
			renderTable(projectData);
		  });

		  pagination.appendChild(btn);
		}
	  }

	  function applyFilter() {
		const type = document.getElementById('filterType').value;
		const keyword = document.getElementById('filterInput').value.toLowerCase();
		const filtered = originalData.filter(p => p[type]?.toLowerCase().includes(keyword));
		currentPage = 1;
		projectData = filtered;
		renderTable(projectData);
	  }
	  function clearFilter() {
		  document.getElementById('filterInput').value = '';
		  projectData = [...originalData];
		  currentPage = 1;
		  renderTable(projectData);
		}


		function viewDetails(index) {
		  const data = projectData[index] || {};

		  const sheetUrl = data.sheetUrl || "#";
		  const downloadUrl = sheetUrl.includes("/edit")
			? sheetUrl.replace("/edit", "/export?format=xlsx")
			: sheetUrl;

		  const modalHtml = `
			<div id="modalOverlay" style="
			  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
			  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
			  z-index: 9999;">
			  <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 100%; position: relative;">
				<button onclick="closeModal()" style="
				  position: absolute; top: 10px; right: 10px; background: #dc3545;
				  color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;">‚úñ</button>
				<h3 style="color:#004080;">üìã ${data.projectTitle}</h3>
				<p><strong>Customer:</strong> ${data.customerName}</p>
				<p><strong>Channel:</strong> ${data.channel}</p>
				<p><strong>EDI Docs:</strong> ${data.ediDocs}</p>
				<p><strong>Start Date:</strong> ${data.startDate}</p>
				<p><strong>Go-Live Date:</strong> ${data.goLiveDate}</p>
				<p><strong>Google Sheet:</strong> 
				  <a href="${sheetUrl}" target="_blank">üìÑ Open</a> | 
				  <a href="${downloadUrl}" target="_blank">‚¨áÔ∏è Download</a>
				</p>
				${data.chartImage ? `<img src="${data.chartImage}" style="width:100%;margin-top:15px;" alt="Timeline Chart">` : ''}
			  </div>
			</div>
		  `;

		  const modal = document.createElement('div');
		  modal.innerHTML = modalHtml;
		  document.body.appendChild(modal);
		}

		function closeModal() {
		  const modal = document.getElementById('modalOverlay');
		  if (modal) modal.remove();
		}



	  function exportCSV() {
		const headers = ['Project Title', 'Customer', 'Channel', 'EDI Docs', 'Start Date', 'Go-Live Date', 'Sheet URL'];
		const rows = projectData.map(p => [
		  p.projectTitle,
		  p.customerName,
		  p.channel,
		  p.ediDocs,
		  p.startDate,
		  p.goLiveDate,
		  p.sheetUrl || ''
		]);

		let csv = headers.join(',') + '\n' + rows.map(r => r.map(field => `"${field}"`).join(',')).join('\n');
		const blob = new Blob([csv], { type: 'text/csv' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = 'project_history.csv';
		a.click();
		URL.revokeObjectURL(url);
	  }

	  // Load on page start
	  fetchProjectHistory();
</script>
<div id="paginationContainer"></div>
</body>
</html>
