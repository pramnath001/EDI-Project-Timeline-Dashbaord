<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EDI Project Plan Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .phase-row {
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr 2fr;
      gap: 10px;
      align-items: center;
      padding: 12px;
      border-left: 6px solid #004080;
      border-radius: 8px;
      background: #f9fbfe;
      margin-bottom: 10px;
    }
    .phase-title {
      font-weight: bold;
      color: #004080;
    }
    .status-select {
      font-weight: bold;
      border: none;
      padding: 8px;
      border-radius: 4px;
    }
    .status-Open { background-color: #eee; color: #333; }
    .status-InProgress { background-color: #007bff; color: white; }
    .status-Pending { background-color: #ffc107; color: black; }
    .status-FollowupRequired { background-color: #dc3545; color: white; }
    .status-Closed { background-color: #28a745; color: white; }
    .owner-CustomerEDI { background-color: #6f42c1; color: white; padding: 4px 8px; border-radius: 4px; }
    .owner-NMBBusinessUser { background-color: #20c997; color: white; padding: 4px 8px; border-radius: 4px; }
    .owner-NMBEDI { background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; }
    .owner-NMBITInfra { background-color: #fd7e14; color: white; padding: 4px 8px; border-radius: 4px; }
    .owner-Others { background-color: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; }
    select[name^='phase_owner_'] {
      font-weight: bold;
      border-radius: 4px;
      border: none;
      padding: 8px;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: #eef3f9;
      margin: 0;
      padding: 0;
    }
    .header {
      background-color: #004080;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.5em;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 40px;
      max-width: 1200px;
      margin: auto;
    }
    .form-section, .phase-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }
    .form-section h3, .phase-section h3 {
      margin-top: 0;
      color: #004080;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: bold;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #004080;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #005cbf;
    }
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 5px;
    }
    @media (max-width: 768px) {
      .phase-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">EDI Project Plan Dashboard</div>
  <form id="ediForm">
    <div class="container">
      <div class="form-section phase-section">
        <h3>General Project Information</h3>
        <div>
          <label>Project Title</label>
          <input type="text" name="projectTitle" required>
        </div>
        <div>
          <label>Customer Name</label>
          <input type="text" name="customerName" required>
        </div>
        <div>
          <label>Start Date</label>
          <input type="date" name="startDate" required>
        </div>
        <div>
          <label>Go-Live Date</label>
          <input type="date" name="goLiveDate" required>
        </div>
        <div>
          <label>Contact Email</label>
          <input type="email" name="contactEmail">
        </div>
        <div>
          <label>NMB Ticket Number</label>
          <input type="text" name="ticketNumber" required>
        </div>
        <div>
          <label>Communication Channel</label>
          <select name="channel" required>
            <option value="OFTP2">OFTP2</option>
            <option value="VAN">VAN</option>
            <option value="AS2">AS2</option>
          </select>
        </div>
        <div>
          <label>EDI Document Types</label>
          <textarea name="ediDocs" placeholder="Eg: DELFOR, DESADV, INVOIC" required></textarea>
        </div>

        <h3 style="margin-top: 40px">Project Phases</h3>
        <div style="margin-bottom: 20px; font-size: 14px; display: flex; flex-wrap: wrap; gap: 10px;">
          <span style="background:#eee; padding:4px 10px; border-radius:4px;">‚ö™ Open</span>
          <span style="background:#007bff; color:white; padding:4px 10px; border-radius:4px;">üü¶ In Progress</span>
          <span style="background:#ffc107; padding:4px 10px; border-radius:4px;">üü® Pending</span>
          <span style="background:#dc3545; color:white; padding:4px 10px; border-radius:4px;">üü• Follow up Required</span>
          <span style="background:#28a745; color:white; padding:4px 10px; border-radius:4px;">üü© Closed</span>
        </div>
        
        <div class="form-section">
          <div class="phase-row">
            <div class="phase-title">1. Requirement Gathering</div>
            <div><label>Start</label><input type="date" name="phase_start_1" required></div>
            <div><label>End</label><input type="date" name="phase_end_1" required></div>
            <div><label>Owner</label>
              <select name="phase_owner_1" required>
                <option>Customer EDI</option><option>NMB Business User</option><option>NMB EDI</option><option>NMB IT Infra</option><option>Others</option>
              </select>
            </div>
            <div><label>Status</label>
              <select name="phase_status_1" required>
                <option>Open</option><option>In Progress</option><option>Pending</option><option>Follow up Required</option><option>Closed</option>
              </select>
            </div>
            <div><label>Comment</label><textarea name="phase_comment_1" rows="1"></textarea></div>
          </div>
		  <div class="phase-row">
			<div class="phase-title">2. Connectivity Setup</div>
			<div><label>Start</label><input type="date" name="phase_start_2" required></div>
			<div><label>End</label><input type="date" name="phase_end_2" required></div>
			<div><label>Owner</label>
			  <select name="phase_owner_2" required>
				<option>Customer EDI</option><option>NMB Business User</option><option>NMB EDI</option><option>NMB IT Infra</option><option>Others</option>
			  </select>
			</div>
			<div><label>Status</label>
			  <select name="phase_status_2" required>
				<option>Open</option><option>In Progress</option><option>Pending</option><option>Follow up Required</option><option>Closed</option>
			  </select>
			</div>
			<div><label>Comment</label><textarea name="phase_comment_2" rows="1"></textarea></div>
		  </div>
		  <div class="phase-row">
			<div class="phase-title">3. EDI Mapping Development</div>
			<div><label>Start</label><input type="date" name="phase_start_3" required></div>
			<div><label>End</label><input type="date" name="phase_end_3" required></div>
			<div><label>Owner</label>
			  <select name="phase_owner_3" required>
				<option>Customer EDI</option><option>NMB Business User</option><option>NMB EDI</option><option>NMB IT Infra</option><option>Others</option>
			  </select>
			</div>
			<div><label>Status</label>
			  <select name="phase_status_3" required>
				<option>Open</option><option>In Progress</option><option>Pending</option><option>Follow up Required</option><option>Closed</option>
			  </select>
			</div>
			<div><label>Comment</label><textarea name="phase_comment_3" rows="1"></textarea></div>
		  </div>
		  <div class="phase-row">
			<div class="phase-title">4. Internal Testing (QA)</div>
			<div><label>Start</label><input type="date" name="phase_start_4" required></div>
			<div><label>End</label><input type="date" name="phase_end_4" required></div>
			<div><label>Owner</label>
			  <select name="phase_owner_4" required>
				<option>Customer EDI</option><option>NMB Business User</option><option>NMB EDI</option><option>NMB IT Infra</option><option>Others</option>
			  </select>
			</div>
			<div><label>Status</label>
			  <select name="phase_status_4" required>
				<option>Open</option><option>In Progress</option><option>Pending</option><option>Follow up Required</option><option>Closed</option>
			  </select>
			</div>
			<div><label>Comment</label><textarea name="phase_comment_4" rows="1"></textarea></div>
		  </div>
		  <div class="phase-row">
			<div class="phase-title">5. Customer Testing (UAT)</div>
			<div><label>Start</label><input type="date" name="phase_start_5" required></div>
			<div><label>End</label><input type="date" name="phase_end_5" required></div>
			<div><label>Owner</label>
			  <select name="phase_owner_5" required>
				<option>Customer EDI</option><option>NMB Business User</option><option>NMB EDI</option><option>NMB IT Infra</option><option>Others</option>
			  </select>
			</div>
			<div><label>Status</label>	
			  <select name="phase_status_5" required>
				<option>Open</option><option>In Progress</option><option>Pending</option><option>Follow up Required</option><option>Closed</option>
			  </select>
			</div>
			<div><label>Comment</label><textarea name="phase_comment_5" rows="1"></textarea></div>
		  </div>
		  <div class="phase-row">
			<div class="phase-title">6. Go-Live Preparation</div>
			<div><label>Start</label><input type="date" name="phase_start_6" required></div>
			<div><label>End</label><input type="date" name="phase_end_6" required></div>
			<div><label>Owner</label>
			  <select name="phase_owner_6" required>
				<option>Customer EDI</option><option>NMB Business User</option><option>NMB EDI</option><option>NMB IT Infra</option><option>Others</option>
			  </select>
			</div>
			<div><label>Status</label>
			  <select name="phase_status_6" required>
				<option>Open</option><option>In Progress</option><option>Pending</option><option>Follow up Required</option><option>Closed</option>
			  </select>
			</div>
			<div><label>Comment</label><textarea name="phase_comment_6" rows="1"></textarea></div>
		  </div>
		  <div class="phase-row">
			<div class="phase-title">7. Go-Live & Hypercare</div>
			<div><label>Start</label><input type="date" name="phase_start_7" required></div>
			<div><label>End</label><input type="date" name="phase_end_7" required></div>
			<div><label>Owner</label>
			  <select name="phase_owner_7" required>
				<option>Customer EDI</option><option>NMB Business User</option><option>NMB EDI</option><option>NMB IT Infra</option><option>Others</option>
			  </select>
			</div>
			<div><label>Status</label>
			  <select name="phase_status_7" required>
				<option>Open</option><option>In Progress</option><option>Pending</option><option>Follow up Required</option><option>Closed</option>
			  </select>
			</div>
			<div><label>Comment</label><textarea name="phase_comment_7" rows="1"></textarea></div>
		  </div>
		</div>         
        <button type="submit">Generate Google Sheet</button>
        <div id="result"></div>
      </div>
    </div>

    <div class="container">
      <div class="form-section phase-section">
        <h3>Timeline Overview</h3>
        <canvas id="timelineChart" width="1000" height="400"></canvas>
        <button id="downloadChart" style="margin-top:15px;">üì• Download Timeline Chart as Image</button>
        <div id="timelineSummary" style="margin-top: 20px; font-size: 14px;"></div>
      </div>
    </div>
  </form>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

 <script>
  // Initialize chart variable
  document.addEventListener('DOMContentLoaded', function () {
  let timelineChart = null;

  // ... [UNCHANGED createTimelineChart, validateDates, collectPhaseData, generateExcelFile etc.]

  // Save project to local storage (optional fallback)
  function saveProjectToHistory(formData) {
    const projectHistory = JSON.parse(localStorage.getItem('projectHistory') || '[]');
    projectHistory.push(formData);
    localStorage.setItem('projectHistory', JSON.stringify(projectHistory));
  }
// Collect phase data for the timeline chart
function collectPhaseData() {
  const phases = [];
  for (let i = 1; i <= 7; i++) {
    const startDate = new Date(document.querySelector(`input[name="phase_start_${i}"]`).value);
    const endDate = new Date(document.querySelector(`input[name="phase_end_${i}"]`).value);
    const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) || 1;
    const status = document.querySelector(`select[name="phase_status_${i}"]`).value;
    const owner = document.querySelector(`select[name="phase_owner_${i}"]`).value;
    const comment = document.querySelector(`textarea[name="phase_comment_${i}"]`).value;
    
    phases.push({
      id: i,
      label: document.querySelector(`.phase-row:nth-child(${i}) .phase-title`).textContent.trim(),
      start: startDate,
      end: endDate,
      duration: duration,
      status: status,
      owner: owner,
      comment: comment
    });
  }
  return phases;
}

// Validate phase dates
function validateDates(startDates, endDates) {
  const errors = [];
  
  // Check each phase's dates
  for (let i = 0; i < startDates.length; i++) {
    if (startDates[i] > endDates[i]) {
      errors.push(`Phase ${i+1}: End date cannot be before start date`);
    }
    
    // Check overlap with next phase (if exists)
    if (i < startDates.length - 1 && endDates[i] > startDates[i+1]) {
      errors.push(`Phase ${i+1} overlaps with Phase ${i+2}`);
    }
  }
  
  return errors;
}

// Create timeline chart
function createTimelineChart(phaseData) {
  try {
    const ctx = document.getElementById('timelineChart').getContext('2d');
    
    if (timelineChart) {
      timelineChart.destroy();
    }

    const backgroundColors = phaseData.map(p => {
      switch (p.status) {
        case 'In Progress': return '#007bff';
        case 'Pending': return '#ffc107';
        case 'Follow up Required': return '#dc3545';
        case 'Closed': return '#28a745';
        default: return '#6c757d';
      }
    });

    const bars = phaseData.map(p => ({
      x: [p.start, p.end],
      y: p.label,
      backgroundColor: getStatusColor(p.status)
	}));

		data: {
		  datasets: [{
			label: 'Project Timeline',
			data: bars, // bars contains objects with {x, y}
			parsing: {
			  xAxisKey: 'x',
			  yAxisKey: 'y'
			},
			backgroundColor: bars.map(p => p.backgroundColor),
			borderSkipped: false,
			barPercentage: 0.6
		  }]
		},
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            position: 'bottom',  // <-- Date axis at bottom
            time: {
              unit: 'day',
              tooltipFormat: 'MMM dd',
              displayFormats: {
                day: 'MMM d'
              }
            },
            title: {
              display: true,
              text: 'Timeline'
            },
            grid: {
              display: true
            }
          },
          y: {
            title: {
              display: false
            },
            ticks: {
              autoSkip: false
            },
            grid: {
              display: false
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function (context) {
                const p = phaseData[context.dataIndex];
                return [
                  `Start: ${p.start.toLocaleDateString()}`,
                  `End: ${p.end.toLocaleDateString()}`,
                  `Duration: ${p.duration} days`,
                  `Status: ${p.status}`,
                  `Owner: ${p.owner}`
                ];
              }
            }
          },
          legend: {
            display: false
          }
        }
      }
    });

    return true;
  } catch (error) {
    console.error("Error generating timeline chart:", error);
    return false;
  }
}


// Generate Excel file as fallback
function generateExcelFile(formData) {
  try {
    // Create workbook
    const wb = XLSX.utils.book_new();
    
    // Prepare data for Project Info sheet
    const projectInfoData = [
      ["Project Title", formData.projectTitle],
      ["Customer Name", formData.customerName],
      ["Start Date", formData.startDate],
      ["Go-Live Date", formData.goLiveDate],
      ["Contact Email", formData.contactEmail],
      ["NMB Ticket Number", formData.ticketNumber],
      ["Communication Channel", formData.channel],
      ["EDI Document Types", formData.ediDocs]
    ];
    
    const projectInfoWS = XLSX.utils.aoa_to_sheet(projectInfoData);
    XLSX.utils.book_append_sheet(wb, projectInfoWS, "Project Info");
    
    // Prepare data for Phases sheet
    const phasesHeader = ["Phase", "Start Date", "End Date", "Duration", "Owner", "Status", "Comments"];
    const phasesData = [phasesHeader];
    
    for (let i = 1; i <= 7; i++) {
      phasesData.push([
        document.querySelector(`.phase-row:nth-child(${i}) .phase-title`).textContent.trim(),
        formData[`phase_start_${i}`],
        formData[`phase_end_${i}`],
        Math.ceil((new Date(formData[`phase_end_${i}`]) - new Date(formData[`phase_start_${i}`])) / (1000 * 60 * 60 * 24)),
        formData[`phase_owner_${i}`],
        formData[`phase_status_${i}`],
        formData[`phase_comment_${i}`]
      ]);
    }
    
    const phasesWS = XLSX.utils.aoa_to_sheet(phasesData);
    XLSX.utils.book_append_sheet(wb, phasesWS, "Project Phases");
    
    // Generate and download file
    const fileName = `EDI_Project_${formData.projectTitle.replace(/[^a-z0-9]/gi, '_')}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    return true;
  } catch (err) {
    console.error("Error generating Excel file:", err);
    return false;
  }
}
  // Form submission handler
  document.getElementById('ediForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    const timelineData = collectPhaseData();

    const dateErrors = validateDates(
      timelineData.map(p => p.start),
      timelineData.map(p => p.end)
    );
    if (dateErrors.length > 0) {
      alert("Please fix these date issues:\n" + dateErrors.join("\n"));
      return;
    }

    if (!createTimelineChart(timelineData)) {
      document.getElementById('result').innerHTML = `<p style="color:red">‚ùå Failed to create timeline chart</p>`;
      return;
    }

    const summaryDiv = document.getElementById('timelineSummary');
    summaryDiv.innerHTML = generateSummaryTable(timelineData);

    try {
      const scriptUrl = 'https://script.google.com/macros/s/AKfycbynyVZcVRmC1RxwPiiYYIK8yPUWKNwV07gA6eZwDOQw0lHRBSPUKZ0_H7OYOFQXLnAl/exec';
      const response = await fetch(scriptUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
      });

      const result = await response.json();
      if (result.status === "success") {
        const sheetUrl = result.sheetUrl;
        const dataObj = Object.fromEntries(formData.entries());
        dataObj.sheetLink = sheetUrl;

        saveProjectToHistory(dataObj); // optional local backup

        document.getElementById('result').innerHTML = `
          <p style="color:green">‚úî Google Sheet created! <a href="${sheetUrl}" target="_blank">üìÑ View Sheet</a></p>
        `;
      } else {
        throw new Error(result.message || "Unknown error");
      }
    } catch (error) {
      console.error("Google Sheet creation failed:", error);
      generateExcelFile(data);
      document.getElementById('result').innerHTML = `
        <p style="color:orange">‚ö† Could not create Google Sheet. Local Excel file generated instead.</p>
        <p>Error: ${error.message}</p>
      `;
    }
  });

  // Generate summary table
  function generateSummaryTable(timelineData) {
    let tableHTML = `
      <table style='width:100%; border-collapse: collapse; margin-top: 20px;'>
        <thead>
          <tr style='background:#004080;color:white;'>
            <th style='padding:8px;border:1px solid #ccc;'>Phase</th>
            <th style='padding:8px;border:1px solid #ccc;'>Start Date</th>
            <th style='padding:8px;border:1px solid #ccc;'>End Date</th>
            <th style='padding:8px;border:1px solid #ccc;'>Duration</th>
          </tr>
        </thead>
        <tbody>`;

    timelineData.forEach(d => {
      tableHTML += `
        <tr>
          <td style='padding:8px;border:1px solid #ccc;'>${d.label}</td>
          <td style='padding:8px;border:1px solid #ccc;'>${d.start.toLocaleDateString()}</td>
          <td style='padding:8px;border:1px solid #ccc;'>${d.end.toLocaleDateString()}</td>
          <td style='padding:8px;border:1px solid #ccc;'>${Math.round(d.duration)} days</td>
        </tr>`;
    });

    tableHTML += '</tbody></table>';
    return tableHTML;
  }

  // Chart image download
  document.getElementById('downloadChart').addEventListener('click', function () {
    if (!timelineChart) {
      alert("Please generate the chart first");
      return;
    }
    const canvas = document.getElementById('timelineChart');
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.fillStyle = "#ffffff";
    tempCtx.fillRect(0, 0, canvas.width, canvas.height);
    tempCtx.drawImage(canvas, 0, 0);
    const link = document.createElement('a');
    link.download = 'edi_timeline.png';
    link.href = tempCanvas.toDataURL('image/png');
    link.click();
  });

  // Dynamic style updates
  function applyDynamicStyling() {
    document.querySelectorAll('select[name^="phase_status_"]').forEach(select => {
      const updateStatusColor = () => {
        select.className = 'status-select status-' + select.value.replace(/ /g, '');
      };
      select.addEventListener('change', updateStatusColor);
      updateStatusColor();
    });

		document.querySelectorAll('select[name^="phase_owner_"]').forEach(select => {
		  const updateOwnerColor = () => {
			select.className = 'owner-' + select.value.replace(/ /g, '');
		  };
		  select.addEventListener('change', updateOwnerColor);
		  updateOwnerColor();
		});
	  }

		  // Init on load
		  
	  applyDynamicStyling(); // Apply dropdown styles

	  // Set default project start and go-live dates
	  const today = new Date();
	  const todayStr = today.toISOString().split('T')[0];

	  const goLive = new Date();
	  goLive.setDate(today.getDate() + 30);
	  const goLiveStr = goLive.toISOString().split('T')[0];

	  document.querySelector('input[name="startDate"]').value = todayStr;
	  document.querySelector('input[name="goLiveDate"]').value = goLiveStr;

	  // Set default start/end dates for each project phase
	  for (let i = 1; i <= 7; i++) {
		const start = new Date();
		start.setDate(today.getDate() + (i - 1) * 4);

		const end = new Date(start);
		end.setDate(end.getDate() + 3);

		const startInput = document.querySelector(`input[name="phase_start_${i}"]`);
		const endInput = document.querySelector(`input[name="phase_end_${i}"]`);

		if (startInput && endInput) {
		  startInput.value = start.toISOString().split('T')[0];
		  endInput.value = end.toISOString().split('T')[0];
		}
	  }
	  });

</script>
</body>
</html>
